C51 COMPILER V9.60.7.0   I2C                                                               12/24/2025 15:58:47 PAGE 1   


C51 COMPILER V9.60.7.0, COMPILATION OF MODULE I2C
OBJECT MODULE PLACED IN .\Objects\I2C.obj
COMPILER INVOKED BY: E:\AAAAAA\Keil_v5\C51\BIN\C51.EXE Lib\I2C.c LARGE OPTIMIZE(8,SPEED) BROWSE INCDIR(.\User;.\Lib;.\Ha
                    -rdware;.\App;.\Bare-MetalMultitasking;.\Hardware\I2Csoft_oled) DEBUG OBJECTEXTEND PRINT(.\Listings\I2C.lst) TABS(2) OBJE
                    -CT(.\Objects\I2C.obj)

line level    source

   1          /*---------------------------------------------------------------------*/
   2          /* --- STC MCU Limited ------------------------------------------------*/
   3          /* --- STC 1T Series MCU Demo Programme -------------------------------*/
   4          /* --- Mobile: (86)13922805190 ----------------------------------------*/
   5          /* --- Fax: 86-0513-55012956,55012947,55012969 ------------------------*/
   6          /* --- Tel: 86-0513-55012928,55012929,55012966 ------------------------*/
   7          /* --- Web: www.STCAI.com ---------------------------------------------*/
   8          /* --- BBS: www.STCAIMCU.com  -----------------------------------------*/
   9          /* --- QQ:  800003751 -------------------------------------------------*/
  10          /* 如果要在程序中使用此代码,请在程序中注明使用了STC的资料及程序            */
  11          /*---------------------------------------------------------------------*/
  12          
  13          #include  "I2C.h"
  14          
  15          u8 xdata I2C_Buffer[I2C_BUF_LENTH];
  16          
  17          //========================================================================
  18          // 函数: void I2C_Init(I2C_InitTypeDef *I2Cx)
  19          // 描述: I2C初始化程序.
  20          // 参数: I2Cx: 结构参数,请参考I2C.h里的定义.
  21          // 返回: none.
  22          // 版本: V1.0, 2012-11-22
  23          //========================================================================
  24          void I2C_Init(I2C_InitTypeDef *I2Cx)
  25          {
  26   1        if(I2Cx->I2C_Mode == I2C_Mode_Master)
  27   1        {
  28   2          I2C_Master();     //设为主机  
  29   2          I2CMSST = 0x00;   //清除I2C主机状态寄存器
  30   2          I2C_SetSpeed(I2Cx->I2C_Speed);
  31   2          if(I2Cx->I2C_MS_WDTA == ENABLE)   I2C_WDTA_EN();  //使能自动发送
  32   2          else                  I2C_WDTA_DIS(); //禁止自动发送
  33   2        }
  34   1        else
  35   1        {
  36   2          I2C_Slave();  //设为从机
  37   2          I2CSLST = 0x00;   //清除I2C从机状态寄存器
  38   2          I2C_Address(I2Cx->I2C_SL_ADR);
  39   2          if(I2Cx->I2C_SL_MA == ENABLE)   I2C_MATCH_EN(); //从机地址比较功能，只接受相匹配地址
  40   2          else                  I2C_MATCH_DIS();  //禁止从机地址比较功能，接受所有设备地址
  41   2        }
  42   1        
  43   1        I2C_Function(I2Cx->I2C_Enable);
  44   1      }
  45          
  46          
  47          //========================================================================
  48          // 函数: NVIC_I2C_Init
  49          // 描述: I2C嵌套向量中断控制器初始化.
  50          // 参数: Mode:     模式, I2C_Mode_Master/I2C_Mode_Slave.
  51          // 参数: State:    中断使能状态, I2C_Mode_Master: ENABLE/DISABLE.
  52          //                              I2C_Mode_Slave: I2C_ESTAI/I2C_ERXI/I2C_ETXI/I2C_ESTOI/DISABLE.
  53          // 参数: Priority: 中断优先级, Priority_0,Priority_1,Priority_2,Priority_3.
C51 COMPILER V9.60.7.0   I2C                                                               12/24/2025 15:58:47 PAGE 2   

  54          // 返回: 执行结果 SUCCESS/FAIL.
  55          // 版本: V1.0, 2020-09-29
  56          //========================================================================
  57          u8 NVIC_I2C_Init(u8 Mode, u8 State, u8 Priority)
  58          {
  59   1        if(Mode > I2C_Mode_Master) return FAIL;
  60   1        if(Priority > Priority_3) return FAIL;
  61   1        if(Mode == I2C_Mode_Master)
  62   1        {
  63   2          I2C_Master_Inturrupt(State);
  64   2        }
  65   1        else if(Mode == I2C_Mode_Slave)
  66   1        {
  67   2          I2CSLCR = (I2CSLCR & ~0x78) | State;
  68   2        }
  69   1        I2C_Priority(Priority);
  70   1        return SUCCESS;
  71   1      }
  72          
  73          //========================================================================
  74          // 函数: u8 Get_MSBusy_Status (void)
  75          // 描述: 获取主机忙碌状态.
  76          // 参数: none.
  77          // 返回: 主机忙碌状态.
  78          // 版本: V1.0, 2012-11-22
  79          //========================================================================
  80          u8 Get_MSBusy_Status(void)
  81          {
  82   1        return (I2CMSST & 0x80);
  83   1      }
  84          
  85          //========================================================================
  86          // 函数: void Wait (void)
  87          // 描述: 等待主机模式I2C控制器执行完成I2CMSCR.
  88          // 参数: none.
  89          // 返回: none.
  90          // 版本: V1.0, 2012-11-22
  91          //========================================================================
  92          void Wait()
  93          {
  94   1        while (!(I2CMSST & 0x40));
  95   1        I2CMSST &= ~0x40;
  96   1      }
  97          
  98          //========================================================================
  99          // 函数: void Start (void)
 100          // 描述: I2C总线起始函数.
 101          // 参数: none.
 102          // 返回: none.
 103          // 版本: V1.0, 2020-09-15
 104          //========================================================================
 105          void Start()
 106          {
 107   1        I2CMSCR = 0x01;                         //发送START命令
 108   1        Wait();
 109   1      }
 110          
 111          //========================================================================
 112          // 函数: void SendData (char dat)
 113          // 描述: I2C发送一个字节数据函数.
 114          // 参数: 发送的数据.
 115          // 返回: none.
C51 COMPILER V9.60.7.0   I2C                                                               12/24/2025 15:58:47 PAGE 3   

 116          // 版本: V1.0, 2020-09-15
 117          //========================================================================
 118          void SendData(char dat)
 119          {
 120   1        I2CTXD = dat;                           //写数据到数据缓冲区
 121   1        I2CMSCR = 0x02;                         //发送SEND命令
 122   1        Wait();
 123   1      }
 124          
 125          //========================================================================
 126          // 函数: void RecvACK (void)
 127          // 描述: I2C获取ACK函数.
 128          // 参数: none.
 129          // 返回: none.
 130          // 版本: V1.0, 2020-09-15
 131          //========================================================================
 132          void RecvACK()
 133          {
 134   1        I2CMSCR = 0x03;                         //发送读ACK命令
 135   1        Wait();
 136   1      }
 137          
 138          //========================================================================
 139          // 函数: char RecvData (void)
 140          // 描述: I2C读取一个字节数据函数.
 141          // 参数: none.
 142          // 返回: 读取数据.
 143          // 版本: V1.0, 2020-09-15
 144          //========================================================================
 145          char RecvData()
 146          {
 147   1        I2CMSCR = 0x04;                         //发送RECV命令
 148   1        Wait();
 149   1        return I2CRXD;
 150   1      }
 151          
 152          //========================================================================
 153          // 函数: void SendACK (void)
 154          // 描述: I2C发送ACK函数.
 155          // 参数: none.
 156          // 返回: none.
 157          // 版本: V1.0, 2020-09-15
 158          //========================================================================
 159          void SendACK()
 160          {
 161   1        I2CMSST = 0x00;                         //设置ACK信号
 162   1        I2CMSCR = 0x05;                         //发送ACK命令
 163   1        Wait();
 164   1      }
 165          
 166          //========================================================================
 167          // 函数: void SendNAK (void)
 168          // 描述: I2C发送NAK函数.
 169          // 参数: none.
 170          // 返回: none.
 171          // 版本: V1.0, 2020-09-15
 172          //========================================================================
 173          void SendNAK()
 174          {
 175   1        I2CMSST = 0x01;                         //设置NAK信号
 176   1        I2CMSCR = 0x05;                         //发送ACK命令
 177   1        Wait();
C51 COMPILER V9.60.7.0   I2C                                                               12/24/2025 15:58:47 PAGE 4   

 178   1      }
 179          
 180          //========================================================================
 181          // 函数: void Stop (void)
 182          // 描述: I2C总线停止函数.
 183          // 参数: none.
 184          // 返回: none.
 185          // 版本: V1.0, 2020-09-15
 186          //========================================================================
 187          void Stop()
 188          {
 189   1        I2CMSCR = 0x06;                         //发送STOP命令
 190   1        Wait();
 191   1      }
 192          
 193          //========================================================================
 194          // 函数: void SendCmdData (u8 cmd, u8 dat)
 195          // 描述: I2C发送一个字节数据函数.
 196          // 参数: 命令/数据.
 197          // 返回: none.
 198          // 版本: V1.0, 2020-09-15
 199          //========================================================================
 200          void SendCmdData(u8 cmd, u8 dat)
 201          {
 202   1        I2CTXD = dat;                           //写数据到数据缓冲区
 203   1        I2CMSCR = cmd;                          //设置命令
 204   1        Wait();
 205   1      }
 206          
 207          //========================================================================
 208          // 函数: void I2C_WriteNbyte(u8 dev_addr, u8 mem_addr, u8 *p, u8 number)
 209          // 描述: I2C写入数据函数.
 210          // 参数: dev_addr: 设备地址, mem_addr: 存储地址, *p写入数据存储位置, number写入数据个数.
 211          // 返回: none.
 212          // 版本: V1.0, 2020-09-15
 213          //========================================================================
 214          void I2C_WriteNbyte(u8 dev_addr, u8 mem_addr, u8 *p, u8 number)  /*  DeviceAddress,WordAddress,First Data 
             -Address,Byte lenth   */
 215          {
 216   1        Start();                                //发送起始命令
 217   1        SendData(dev_addr);                     //发送设备地址+写命令
 218   1        RecvACK();
 219   1        SendData(mem_addr);                     //发送存储地址
 220   1        RecvACK();
 221   1        do
 222   1        {
 223   2          SendData(*p++);
 224   2          RecvACK();
 225   2        }
 226   1        while(--number);
 227   1        Stop();                                 //发送停止命令
 228   1      }
 229          
 230          //========================================================================
 231          // 函数: void I2C_ReadNbyte(u8 dev_addr, u8 mem_addr, u8 *p, u8 number)
 232          // 描述: I2C读取数据函数.
 233          // 参数: dev_addr: 设备地址, mem_addr: 存储地址, *p读取数据存储位置, number读取数据个数.
 234          // 返回: none.
 235          // 版本: V1.0, 2020-09-15
 236          //========================================================================
 237          void I2C_ReadNbyte(u8 dev_addr, u8 mem_addr, u8 *p, u8 number)   /*  DeviceAddress,WordAddress,First Data 
             -Address,Byte lenth   */
C51 COMPILER V9.60.7.0   I2C                                                               12/24/2025 15:58:47 PAGE 5   

 238          {
 239   1        Start();                                //发送起始命令
 240   1        SendData(dev_addr);                     //发送设备地址+写命令
 241   1        RecvACK();
 242   1        SendData(mem_addr);                     //发送存储地址
 243   1        RecvACK();
 244   1        Start();                                //发送起始命令
 245   1        SendData(dev_addr|1);                   //发送设备地址+读命令
 246   1        RecvACK();
 247   1        do
 248   1        {
 249   2          *p = RecvData();
 250   2          p++;
 251   2          if(number != 1) SendACK();          //send ACK
 252   2        }
 253   1        while(--number);
 254   1        SendNAK();                              //send no ACK 
 255   1        Stop();                                 //发送停止命令
 256   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    457    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =      8      12
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
